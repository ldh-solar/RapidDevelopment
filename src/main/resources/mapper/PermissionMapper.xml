<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gddlkj.example.mapper.PermissionMapper">
    <resultMap id="TreeMap" type="com.gddlkj.example.model.vo.PermissionTreeVo">
        <id column="Id" property="id" jdbcType="BIGINT"/>
        <collection column="id" property="children" ofType="com.gddlkj.example.model.vo.PermissionTreeVo"
                    javaType="java.util.ArrayList" select="selectPermissionChildren"/>
    </resultMap>

    <select id="selectPermissionChildren" resultMap="TreeMap" parameterType="java.lang.Long" >
        select
        *
        from t_permission
        where pid = #{pid}
        and is_del =0
    </select>

    <select id="listTree" resultMap="TreeMap">
        select
        *
        from t_permission
        where pid = 0
        and type='menu'
        and is_del =0
    </select>

    <select id="findByUserId" resultType="com.gddlkj.example.model.domain.Permission">
    select distinct
    p.*
    from t_role_permission r inner join t_permission p on r.permission_id = p.id
    where r.role_id in (select role_id from t_user_role inner join t_role on t_user_role.role_id = t_role.id where user_id = #{userId} and t_role.is_del=0)
    and p.is_del=0
</select>
    <select id="findByRoleId" resultType="com.gddlkj.example.model.domain.Permission">
        select p.id from t_role_permission r inner join t_permission p on r.permission_id = p.id
        where r.role_id=#{id}
        and p.is_del=0
    </select>


</mapper>
